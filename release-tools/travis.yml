language: go
sudo: required
services:
  - docker
arch:
  - amd64
  - s390x
git:
  depth: false
go: 1.13.3
before_script:
#Setup postgresql for s390x environment
- if [[ $(uname -m) == 's390x' ]]; then
  apt-get update && apt-get install -y ghc cabal-install ;
  cabal update && cabal install ShellCheck==0.6.0 ;
  export PATH=$HOME/.cabal/bin:$PATH ;
  fi
- mkdir -p bin
- wget https://github.com/golang/dep/releases/download/v0.5.1/dep-linux-$(go env GOARCH) -O bin/dep
- chmod u+x bin/dep
- export PATH=$PWD/bin:$PATH
script:
- make -k all test GOFLAGS_VENDOR=$( [ -d vendor ] && echo '-mod=vendor' )
after_success:
  - if [ "${TRAVIS_PULL_REQUEST}" == "false" ]; then
      docker login -u "${DOCKER_USERNAME}" -p "${DOCKER_PASSWORD}" quay.io;
      make push GOFLAGS_VENDOR=$( [ -d vendor ] && echo '-mod=vendor' );
    fi
